<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SmartGallery: {{ current_folder_info.display_name }}</title>
    <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='galleryout/favicon.ico') }}">
    <link href="https://cdn.jsdelivr.net/npm/tom-select@2.4.3/dist/css/tom-select.css" rel="stylesheet">
    <style>
        :root {
            --bg-color: #0a0a0a; --surface-color: #1a1a1a; --surface-hover: #252525;
            --primary-color: #007bff; --primary-hover: #0056b3; --text-color: #f8f9fa;
            --text-muted: #adb5bd; --border-color: #343a40; --danger-color: #dc3545;
            --danger-hover: #c82333; --favorite-color: #ffc107; --workflow-color: #28a745;
            --success-color: #20c997; --gradient-primary: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --gradient-secondary: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            --glass-bg: rgba(255, 255, 255, 0.05); --glass-border: rgba(255, 255, 255, 0.1);
            --shadow-sm: 0 2px 4px rgba(0,0,0,0.1); --shadow-md: 0 4px 12px rgba(0,0,0,0.2);
            --shadow-lg: 0 8px 24px rgba(0,0,0,0.3);
        }
        * { box-sizing: border-box; }
        html { scroll-behavior: smooth; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Inter", sans-serif; margin: 0; background: var(--bg-color); color: var(--text-color); line-height: 1.6; display: flex; min-height: 100vh; }
        body.lightbox-open, body.modal-open { overflow: hidden; }
        .sidebar { width: 320px; background: var(--surface-color); border-right: 1px solid var(--border-color); padding: 1.5rem; display: flex; flex-direction: column; height: 100vh; position: sticky; top: 0; overflow-y: auto; }
        .main-content { flex-grow: 1; padding-bottom: 80px; }
        .sidebar-header { margin-bottom: 1.5rem; display: flex; justify-content: space-between; align-items: center; }
        .sidebar-header h1 { margin: 0; font-size: 1.8rem; font-weight: 700; background: var(--gradient-primary); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
        #sidebar-toggle-btn { display: none; background: var(--surface-hover); color: var(--text-color); border: 1px solid var(--border-color); padding: 0.5rem 1rem; border-radius: 8px; cursor: pointer; font-size: 0.9rem; font-weight: 600; }
        .folder-tree, .folder-tree ul { list-style: none; padding: 0; margin: 0; }
        .folder-tree { flex-grow: 1; }
        .folder-tree li { padding-left: 20px; position: relative; }
        .folder-tree > li:first-child { padding-left: 0; }
        .folder-item { display: flex; align-items: center; padding: 8px; border-radius: 8px; transition: background-color 0.2s; position: relative; }
        .folder-item:hover { background-color: var(--surface-hover); }
        .folder-item.active { background-color: var(--primary-color); color: white; font-weight: 600; }
        .toggle-btn { position: absolute; left: 0; top: 50%; transform: translateY(-50%); width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; color: var(--text-muted); cursor: pointer; font-size: 1.1rem; line-height: 1; user-select: none; }
        .toggle-btn.empty { visibility: hidden; }
        .folder-link { flex-grow: 1; text-decoration: none; color: inherit; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-left: 25px; cursor: pointer; }
        .folder-link.navigation-link { cursor: pointer; }
        .folder-actions { margin-left: auto; display: flex; }
        .folder-action-btn { background: none; border: none; color: inherit; cursor: pointer; padding: 4px; border-radius: 4px; font-size: 0.9rem; opacity: 0.7; transition: all 0.2s; }
        .folder-action-btn:hover { opacity: 1; background-color: rgba(255,255,255,0.15); }
        .folder-tree li.collapsed > ul { display: none; }
        .folder-tree li:not(.collapsed) > .folder-item > .toggle-btn::before { content: '▾'; }
        .folder-tree li.collapsed > .folder-item > .toggle-btn::before { content: '▸'; }
        .folder-tree li.no-children > .folder-item > .toggle-btn { visibility: hidden; }
        .folder-link.navigation-link { cursor: pointer; transition: color 0.2s; }
        .folder-link.navigation-link:not(.no-children):hover { color: var(--primary-color) !important; text-decoration: underline; }
        #create-folder-btn { width: 100%; background: var(--gradient-secondary); color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 12px; cursor: pointer; font-size: 0.9rem; font-weight: 600; transition: all 0.3s; box-shadow: var(--shadow-sm); margin-top: 1.5rem; }
        #create-folder-btn:hover { transform: translateY(-2px); box-shadow: var(--shadow-md); }
        .breadcrumbs { display: flex; align-items: center; gap: 0.5rem; padding: 1.5rem 2rem; background: var(--surface-color); border-bottom: 1px solid var(--border-color); flex-wrap: wrap; }
        .breadcrumbs a, .breadcrumbs span { color: var(--text-muted); text-decoration: none; font-weight: 500; }
        .breadcrumbs a:hover { color: var(--text-color); }
        .breadcrumbs span:last-child { color: var(--text-color); font-weight: 700; }
        .filter-bar { padding: 1.5rem 2rem; }
        .filter-bar form { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem; align-items: end; }
        .filter-group { display: flex; flex-direction: column; }
        .filter-bar label { font-weight: 600; margin-bottom: 0.5rem; color: var(--text-muted); font-size: 0.85rem; text-transform: uppercase; letter-spacing: 0.5px; }
        .filter-bar select, .filter-bar input[type="text"], .filter-bar button, .filter-bar a { background: var(--glass-bg); color: var(--text-color); border: 1px solid var(--glass-border); border-radius: 8px; padding: 0.75rem 1rem; font-size: 0.9rem; transition: all 0.3s; backdrop-filter: blur(10px); }
        .filter-bar input[type="text"]:focus { outline: none; border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1); }
        .filter-bar button { background: var(--primary-color); cursor: pointer; font-weight: 600; color: white; border: 1px solid var(--primary-color); }
        .filter-bar button:hover { background: var(--primary-hover); transform: translateY(-1px); }
        .filter-bar button.refresh-btn { background: var(--workflow-color); border-color: var(--workflow-color); }
        .filter-bar a { text-decoration: none; text-align: center; color: var(--text-muted); }
        .filter-bar a:hover { background: var(--surface-hover); color: var(--text-color); }
        .filter-group-inline { display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.5rem; }
        .filter-group-inline input[type="checkbox"] { width: 18px; height: 18px; accent-color: var(--primary-color); }
        .filter-actions { display: flex; gap: 0.75rem; justify-content: flex-start; flex-wrap: wrap; }
        .filter-actions .sort-btn {
            background: var(--surface-hover);
            color: var(--text-color);
            font-weight: 600;
        }
        .ts-control { background: var(--glass-bg) !important; border: 1px solid var(--glass-border) !important; border-radius: 8px !important; backdrop-filter: blur(10px) !important; }
        .ts-dropdown, .ts-control, .ts-control input { color: var(--text-color) !important; }
        .ts-dropdown { background: var(--surface-color) !important; border: 1px solid var(--border-color) !important; z-index: 1000; border-radius: 8px !important; box-shadow: var(--shadow-lg) !important; }
        #gallery-anchor { display: block; position: relative; top: -20px; visibility: hidden; }
        .gallery-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 2rem; padding: 2rem; min-height: 50vh; }
        .gallery-item { background: var(--glass-bg); border-radius: 16px; overflow: hidden; box-shadow: var(--shadow-sm); display: flex; flex-direction: column; position: relative; border: 2px solid transparent; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); backdrop-filter: blur(20px); border: 1px solid var(--glass-border); }
        .gallery-item:hover { transform: translateY(-4px); box-shadow: var(--shadow-lg); }
        .gallery-item.selected { border-color: var(--primary-color); box-shadow: 0 0 0 4px rgba(0, 123, 255, 0.2); }
        .selection-checkmark { position: absolute; bottom: 12px; right: 12px; width: 24px; height: 24px; background: rgba(0,0,0,0.6); border: 2px solid var(--text-color); border-radius: 50%; display: flex; justify-content: center; align-items: center; z-index: 11; transition: all 0.3s; color: transparent; cursor: pointer; font-size: 12px; backdrop-filter: blur(10px); }
        .gallery-item.selected .selection-checkmark { background: var(--primary-color); border-color: var(--primary-color); color: white; transform: scale(1.1); }
        .thumbnail-link { cursor: pointer; }
        .thumbnail-wrapper { position: relative; width: 100%; background: var(--surface-color); overflow: hidden; }
        .thumbnail-wrapper img, .thumbnail-wrapper video { display: block; width: 100%; height: auto; transition: transform 0.3s; }
        .gallery-item:hover .thumbnail-wrapper img, .gallery-item:hover .thumbnail-wrapper video { transform: scale(1.05); }
        .item-info { padding: 1.5rem; flex-grow: 1; display: flex; flex-direction: column; justify-content: space-between; padding-bottom: 48px; }
        .item-info p { margin: 0 0 1.5rem 0; word-wrap: break-word; font-size: 0.95rem; font-weight: 500; line-height: 1.4; }
        .item-actions { display: flex; gap: 0.75rem; margin-top: auto; flex-wrap: wrap; }
        .item-actions a, .item-actions button { display: inline-flex; align-items: center; justify-content: center; text-decoration: none; background: var(--glass-bg); color: var(--text-color); padding: 0.6rem 1rem; border-radius: 8px; font-size: 0.8rem; border: 1px solid var(--glass-border); cursor: pointer; transition: all 0.3s; font-weight: 500; backdrop-filter: blur(10px); }
        .item-actions .delete-btn { background: var(--danger-color); border-color: var(--danger-color); color: white; }
        .favorite-btn.favorited { background: var(--favorite-color); color: #000; border-color: var(--favorite-color); }
        .duration-overlay { position: absolute; bottom: 8px; right: 8px; background: rgba(0,0,0,0.8); color: white; padding: 4px 8px; border-radius: 6px; font-size: 0.75rem; font-weight: 500; backdrop-filter: blur(10px); z-index: 10; }
        .workflow-badge { position: absolute; top: 8px; left: 8px; background: var(--workflow-color); color: white; padding: 4px 10px; border-radius: 6px; font-size: 0.75rem; text-decoration: none; font-weight: 600; }
        #selection-bar { position: fixed; bottom: 0; transform: translateY(100%); transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1); left: 320px; right: 0; background: var(--glass-bg); border-top: 1px solid var(--glass-border); padding: 1.5rem; display: flex; align-items: center; gap: 1rem; z-index: 1001; box-sizing: border-box; backdrop-filter: blur(20px); flex-wrap: wrap; }
        #selection-bar.visible { transform: translateY(0); }
        #selection-bar button { padding: 0.75rem 1.5rem; font-size: 0.9rem; border-radius: 8px; border: none; background: var(--primary-color); color: white; cursor: pointer; transition: all 0.3s; font-weight: 600; }
        #selection-bar .delete-btn { background: var(--danger-color); }
        #selection-counter { font-weight: 700; margin-right: auto; padding-left: 1rem; color: var(--primary-color); }
        #drag-drop-overlay { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.7); z-index: 1002; display: none; opacity: 0; transition: opacity 0.3s; backdrop-filter: blur(5px); }
        #drag-drop-overlay.visible { display: block; opacity: 1; }
        #drop-zone-panel { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 400px; z-index: 1003; background: var(--surface-color); border: 1px solid var(--border-color); border-radius: 16px; box-shadow: var(--shadow-lg); display: none; flex-direction: column; max-height: 80vh; }
        #drop-zone-panel.visible { display: flex; }
        #drop-zone-panel h3 { margin: 0; padding: 1.5rem; text-align: center; border-bottom: 1px solid var(--border-color); font-weight: 600; background: var(--gradient-primary); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
        #drop-zone-folders { overflow-y: auto; display: flex; flex-direction: column; padding: 1rem; max-height: 60vh; }
        .drop-zone-folder-item { display: flex; align-items: center; padding: 8px; border-radius: 8px; transition: background-color 0.2s; cursor: pointer; position: relative; }
        .drop-zone-folder-item:hover { background-color: var(--surface-hover); }
        .drop-zone-folder-item .folder-link { flex-grow: 1; text-decoration: none; color: inherit; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-left: 25px; cursor: pointer; }
        .drop-zone-folder-item .folder-link:hover { background-color: rgba(0, 123, 255, 0.2); }
        .drop-zone-folder-item .toggle-btn { position: absolute; left: 0; top: 50%; transform: translateY(-50%); width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; color: var(--text-muted); cursor: pointer; font-size: 1.1rem; line-height: 1; user-select: none; }
        .drop-zone-folder-item .toggle-btn.empty { visibility: hidden; }
        #cancel-drop-btn { background: var(--danger-color); color: white; border: none; padding: 1rem; cursor: pointer; border-bottom-left-radius: 16px; border-bottom-right-radius: 16px; font-weight: 600; transition: background-color 0.3s; }
        #loader-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg-color); z-index: 9999; display: flex; justify-content: center; align-items: center; transition: opacity 0.4s; }
        .loader { border: 4px solid var(--surface-color); border-top: 4px solid var(--primary-color); border-radius: 50%; width: 48px; height: 48px; animation: spin 1.2s linear infinite; }
        @keyframes spin { 100% { transform: rotate(360deg); } }
        
        #lightbox-overlay { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.95); backdrop-filter: blur(20px); z-index: 2000; display: flex; justify-content: center; align-items: center; opacity: 0; pointer-events: none; transition: opacity 0.4s cubic-bezier(0.4, 0, 0.2, 1); }
        #lightbox-overlay.visible { opacity: 1; pointer-events: auto; }
        .lightbox-nav { position: absolute; top: 50%; transform: translateY(-50%); background: rgba(0,0,0,0.6); color: white; border: 1px solid rgba(255,255,255,0.2); border-radius: 50%; width: 60px; height: 60px; font-size: 1.8rem; cursor: pointer; transition: all 0.3s; display: flex; justify-content: center; align-items: center; backdrop-filter: blur(10px); z-index: 2001; }
        #lightbox-prev { left: 30px; }
        #lightbox-next { right: 30px; }
        #lightbox-header {
            position: absolute; top: 0; left: 0; right: 0; z-index: 2002;
            padding: 1rem; background: linear-gradient(180deg, rgba(0,0,0,0.8) 0%, rgba(0,0,0,0.4) 70%, transparent 100%);
            backdrop-filter: blur(10px); display: flex; flex-direction: column;
            gap: 1rem; align-items: center; text-align: center;
        }
        #lightbox-title { font-size: 1.1rem; font-weight: 600; color: white; word-break: break-word; hyphens: auto; max-width: 90vw; }
        #lightbox-toolbar { display: flex; justify-content: center; flex-wrap: wrap; gap: 0.75rem; }
        #lightbox-toolbar button, #lightbox-toolbar a {
            background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2);
            color: white; padding: 0.75rem; border-radius: 10px; font-size: 1.2rem; cursor: pointer; transition: all 0.3s;
            text-decoration: none; display: flex; align-items: center; justify-content: center;
            min-width: 44px; height: 44px; backdrop-filter: blur(10px);
        }
        #lightbox-toolbar button:hover, #lightbox-toolbar a:hover { background: rgba(255,255,255,0.2); }
        #lightbox-content {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            width: 100%; height: 100%; padding: 10rem 1rem 2rem; 
        }
        #lightbox-media { display: flex; align-items: center; justify-content: center; max-width: 95vw; max-height: 80vh; }
        #lightbox-media img, #lightbox-media video { max-width: 100%; max-height: 100%; object-fit: contain; border-radius: 12px; box-shadow: var(--shadow-lg); cursor: grab; }
        
        #backToTopBtn { display: none; position: fixed; bottom: 110px; right: 30px; z-index: 99; font-size: 1.2rem; border: none; background: var(--primary-color); color: white; cursor: pointer; padding: 12px 16px; border-radius: 50%; transition: all 0.3s; box-shadow: var(--shadow-md); }
        #load-more-container { text-align: center; padding: 3rem; }
        #load-more-btn { background: var(--gradient-primary); color: white; border: none; padding: 1rem 2.5rem; border-radius: 12px; cursor: pointer; font-size: 1rem; font-weight: 600; transition: all 0.3s; box-shadow: var(--shadow-sm); }
        .empty-state { text-align: center; padding: 4rem 2rem; color: var(--text-muted); }
        
        #node-summary-overlay {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            background: rgba(0,0,0,0.8); backdrop-filter: blur(10px);
            z-index: 2100; display: flex; justify-content: center; align-items: center;
            opacity: 0; pointer-events: none; transition: opacity 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        #node-summary-overlay.visible { opacity: 1; pointer-events: auto; }
        .node-summary-panel {
            background: var(--surface-color); border: 1px solid var(--border-color);
            border-radius: 16px; box-shadow: var(--shadow-lg);
            width: 90vw; /* Usa il 90% della larghezza della viewport */
            max-width: 900px; /* NUOVA larghezza massima, aumentata di 300px */
            max-height: 85vh; display: flex; flex-direction: column;
            transform: scale(0.95); transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        #node-summary-overlay.visible .node-summary-panel { transform: scale(1); }
        .node-summary-header {
            display: flex; justify-content: space-between; align-items: center;
            padding: 1rem 1.5rem; border-bottom: 1px solid var(--border-color);
            position: sticky; top: 0; background: var(--surface-color);
        }
        .node-summary-header h2 { margin: 0; font-size: 1.2rem; font-weight: 600; }
        .node-summary-header .close-btn { background: none; border: none; color: var(--text-muted); font-size: 1.8rem; cursor: pointer; padding: 0; line-height: 1; }
        #node-summary-content { padding: 1.5rem; overflow-y: auto; }
        .summary-node-item { margin-bottom: 1.5rem; border-radius: 8px; overflow: hidden; border: 1px solid var(--border-color); }
        .summary-node-header { color: white; padding: 0.75rem 1rem; font-weight: bold; font-size: 0.9rem; }
        .summary-node-header small { opacity: 0.8; font-weight: normal; margin-left: 0.5rem; }
        .summary-node-params { list-style: none; margin: 0; padding: 1rem; background: var(--glass-bg); }
        .summary-node-params li { padding: 0.5rem 0; font-size: 1rem; /* FONT AUMENTATO */ border-bottom: 1px solid var(--glass-border); }
        .summary-node-params li:last-child { border-bottom: none; }
        .summary-node-params strong { color: var(--text-color); margin-right: 0.5rem; }
        .summary-node-params code {
            color: var(--text-muted); word-break: break-all; white-space: pre-wrap;
            background: rgba(0,0,0,0.2); padding: 2px 5px; border-radius: 4px;
        }

        @media (max-width: 1024px) {
            body { flex-direction: column; }
            .sidebar { width: 100%; height: auto; position: static; border-right: none; border-bottom: 1px solid var(--border-color); }
            #selection-bar { left: 0; }
            #sidebar-toggle-btn { display: block; }
            .sidebar.nav-collapsed nav,
            .sidebar.nav-collapsed #create-folder-btn {
                display: none;
            }
        }
        @media (max-width: 768px) {
            .filter-bar form { grid-template-columns: 1fr; }
            .gallery-container { grid-template-columns: 1fr; padding: 1rem; }
            #selection-bar { flex-direction: column; align-items: stretch; gap: 0.5rem; padding: 1rem; }
            #selection-bar .actions-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.5rem; width: 100%; }
            #selection-bar > #select-all-btn, #selection-bar > #deselect-all-btn { grid-column: span 2; }
            #selection-counter { text-align: center; padding-left: 0; margin-bottom: 0.5rem; }
            #drop-zone-panel { width: 90vw; }
            .lightbox-nav { width: 50px; height: 50px; }
            #lightbox-prev { left: 10px; }
            #lightbox-next { right: 10px; }
        }
        @media (max-width: 768px) {
            .node-summary-panel {
                width: 95vw; /* Su mobile, occupa quasi tutto lo schermo */
                max-height: 90vh; /* Permetti un'altezza leggermente maggiore */
            }

            .summary-node-params li {
                font-size: 0.9rem; /* Un font leggermente più piccolo su mobile per non occupare troppo spazio verticale */
            }
        }
    </style>
</head>
<body>
    {% macro render_folder_tree(folder_key, folders, current_folder_key, protected_keys, ancestor_keys, is_move_panel=false) %}
        {% set folder = folders.get(folder_key) %}
        {% if folder is not none %}
            {% set has_children = folder.children and folder.children|length > 0 %}
            {% set is_collapsed = folder_key not in ancestor_keys %}
            <li data-folder-key="{{ folder_key }}" class="{{ 'collapsed' if is_collapsed else '' }} {{ 'no-children' if not has_children else '' }}">
                <div class="{{ 'folder-item' if not is_move_panel else 'drop-zone-folder-item' }}">
                    <span class="toggle-btn {{ 'empty' if not has_children else '' }}"></span>
                    {% if is_move_panel %}
                        <span class="folder-link" data-folder-key="{{ folder_key }}" title="{{ folder.display_name }}">
                            📁 {{ folder.display_name }}
                        </span>
                    {% else %}
                        <span class="folder-link navigation-link {{ 'active' if folder_key == current_folder_key else '' }}" 
                              data-folder-key="{{ folder_key }}" 
                              data-folder-url="{{ url_for('gallery_view', folder_key=folder_key) }}"
                              title="{{ folder.display_name }} {% if has_children %}(Click to expand, Double-click to navigate){% endif %}">
                            📁 {{ folder.display_name }}
                        </span>
                    {% endif %}
                    {% if not is_move_panel and folder_key != '_root_' and folder_key not in protected_keys %}
                    <div class="folder-actions">
                        <button class="folder-action-btn" title="Rename" onclick="renameFolder(event, '{{ folder_key }}', '{{ folder.display_name }}')">✏️</button>
                        {% if deletion_allowed %}
                        <button class="folder-action-btn" title="Delete" onclick="deleteFolder(event, '{{ folder_key }}', '{{ folder.display_name }}')">🗑️</button>
                        {% endif %}
                    </div>
                    {% endif %}
                </div>
                {% if has_children %}
                <ul>
                    {% for child_key in folder.children %}
                        {{ render_folder_tree(child_key, folders, current_folder_key, protected_keys, ancestor_keys, is_move_panel) }}
                    {% endfor %}
                </ul>
                {% endif %}
            </li>
        {% endif %}
    {% endmacro %}

    <aside class="sidebar">
        <div class="sidebar-header">
            <a href="{{ url_for('gallery_view', folder_key='_root_') }}" style="text-decoration: none;"><h1>SmartGallery</h1></a>
            <button id="sidebar-toggle-btn">☰ Folders</button>
        </div>
        <nav>
            <ul class="folder-tree" id="folder-tree-nav">
                {{ render_folder_tree(folder_key='_root_', folders=folders, current_folder_key=current_folder_key, protected_keys=protected_folder_keys, ancestor_keys=ancestor_keys) }}
            </ul>
        </nav>
        <button id="create-folder-btn">➕ Create New Folder</button>
    </aside>

    <div class="main-content">
        <header class="breadcrumbs">
            {% for crumb in breadcrumbs %}
                <a href="{{ url_for('gallery_view', folder_key=crumb.key) }}">{{ crumb.display_name }}</a>
                {% if not loop.last %}<span>/</span>{% endif %}
            {% endfor %}
        </header>
        <div class="filter-bar">
             <form method="GET" action="{{ url_for('gallery_view', folder_key=current_folder_key) }}">
                <div class="filter-group"><label for="search-input">🔍 Search by Name</label><input type="text" name="search" id="search-input" placeholder="Search files in this folder..." value="{{ request.args.get('search', '') }}"></div>
                <div class="filter-group"><label for="extension-select">📄 Extensions</label><select name="extension" id="extension-select" multiple>{% for ext in available_extensions %}<option value="{{ ext }}" {% if ext in selected_extensions %}selected{% endif %}>{{ ext }}</option>{% endfor %}</select></div>
                <div class="filter-group"><label for="prefix-select">🏷️ Prefixes</label><select name="prefix" id="prefix-select" multiple>{% for pfx in available_prefixes %}{% if pfx != '.gallery ' %}<option value="{{ pfx }}" {% if pfx in selected_prefixes %}selected{% endif %}>{{ pfx }}</option>{% endif %}{% endfor %}</select></div>
                <div class="filter-group"><div class="filter-group-inline"><input type="checkbox" name="favorites" id="favorites-check" value="true" {% if show_favorites %}checked{% endif %}><label for="favorites-check">⭐ Favorites Only</label></div></div>
                <div class="filter-group">
                    <label>Actions</label>
                    <div class="filter-actions">
                        {# --- Inizio Logica Corretta per il Link di Ordinamento --- #}
                        {% set next_sort_order = 'asc' if current_sort_order == 'desc' else 'desc' %}
                        
                        {# Crea un dizionario con tutti i parametri della query corrente (preservando valori multipli come le estensioni)
                           e aggiunge/sovrascrive il parametro 'sort_order' con il nuovo valore. #}
                        {% set query_params = dict(request.args.to_dict(flat=False), sort_order=next_sort_order) %}
                        
                        <a href="{{ url_for('gallery_view', folder_key=current_folder_key, **query_params) }}" class="sort-btn" title="Change sort order">
                            Sort by Date {% if current_sort_order == 'asc' %}↑{% else %}↓{% endif %}
                        </a>
                        {# --- Fine Logica Corretta per il Link di Ordinamento --- #}

                        {# --- REINSERIMENTO DEI BOTTONI MANCANTI --- #}
                        <button type="submit">🔍 Filter</button>
                        <a href="{{ url_for('gallery_view', folder_key=current_folder_key) }}">🔄 Reset</a>
                        <button type="button" id="refresh-btn" class="refresh-btn">♻️ Refresh</button>
                    </div>
                </div>
            </form>
        </div>
        <div id="gallery-anchor"></div>
        <main class="gallery-container" id="gallery-container"></main>
        <div id="load-more-container"><button id="load-more-btn">📂 Load More</button></div>
    </div>

    <button onclick="scrollToTop()" id="backToTopBtn" title="Back to top">⬆️</button>
    <div id="drag-drop-overlay"></div>
    <div id="drop-zone-panel"><h3 id="drop-zone-title">📁 Move to Folder:</h3><div id="drop-zone-folders"></div><button id="cancel-drop-btn">❌ Cancel</button></div>
    <div id="selection-bar">
        <span id="selection-counter">0 files selected</span>
        <div class="actions-grid">
            <button id="move-selected-btn">📁 Move</button>
            <button id="favorite-selected-btn">⭐ Add</button>
            <button id="unfavorite-selected-btn">☆ Remove</button>
            {% if deletion_allowed %}
            <button id="delete-selected-btn" class="delete-btn">🗑️ Delete</button>
            {% endif %}
            <button id="select-all-btn">✅ All</button>
            <button id="deselect-all-btn">❌ None</button>
        </div>
    </div>
    
    <div id="lightbox-overlay">
        <div id="lightbox-header">
            <div id="lightbox-title"></div>
            <!-- MODIFICATO: Aggiunto il pulsante Node Summary alla toolbar della Lightbox -->
            <div id="lightbox-toolbar">
                <button id="lightbox-zoom-out" title="Zoom out">-</button>
                <button id="lightbox-zoom-in" title="Zoom in">+</button>
                <a id="lightbox-download" href="#" title="Download File">💾</a>
                <button id="lightbox-summary-btn" title="Node Summary">📝</button>
                <a id="lightbox-workflow" href="#" title="Download Workflow" class="workflow-btn">⚙️</a>
                <a id="lightbox-new-tab" href="#" target="_blank" title="Open in new tab">↗️</a>
                <button class="close-btn" onclick="closeLightbox()" title="Close (Esc)">×</button>
            </div>
        </div>
        <div id="lightbox-content">
            <div id="lightbox-media"></div>
        </div>
        <button id="lightbox-prev" class="lightbox-nav" title="Previous (←)">‹</button>
        <button id="lightbox-next" class="lightbox-nav" title="Next (→)">›</button>
    </div>
    
    <div id="node-summary-overlay">
        <div class="node-summary-panel">
            <div class="node-summary-header">
                <h2>📝 Node Summary</h2>
                <button class="close-btn" id="close-summary-btn">×</button>
            </div>
            <div id="node-summary-content"></div>
        </div>
    </div>

    <div id="loader-overlay"><div class="loader"></div></div>
    <script src="https://cdn.jsdelivr.net/npm/tom-select@2.4.3/dist/js/tom-select.complete.min.js"></script>
    <script>
        const foldersData = {{ folders | tojson }};
        const protectedFolderKeys = {{ protected_folder_keys | tojson }};
        const initialFiles = {{ files | tojson }};
        const totalFiles = {{ total_files }};
        const currentFolderKey = '{{ current_folder_key }}';
        const deletionAllowed = {{ deletion_allowed | tojson }};

        const galleryContainer = document.getElementById('gallery-container');
        const selectionBar = document.getElementById('selection-bar');
        const selectionCounter = document.getElementById('selection-counter');
        const loaderOverlay = document.getElementById('loader-overlay');
        const backToTopBtn = document.getElementById('backToTopBtn');

        let currentItemCount = 0;
        let galleryItems = [];
        let allFilesData = [];
        const selectedFiles = new Set();
        let lastSelectedItem = null;

        function handleError(error) {
            console.error('Error:', error);
            showNotification('A network or server error occurred.', 'error');
        }

        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            notification.style.cssText = `position: fixed; top: 20px; right: 20px; padding: 1rem 1.5rem; border-radius: 8px; color: white; font-weight: 500; z-index: 10000; transform: translateX(400px); transition: transform 0.3s ease; background: ${type === 'error' ? 'var(--danger-color)' : type === 'success' ? 'var(--success-color)' : 'var(--primary-color)'}; box-shadow: var(--shadow-lg); backdrop-filter: blur(10px);`;
            document.body.appendChild(notification);
            setTimeout(() => notification.style.transform = 'translateX(0)', 100);
            setTimeout(() => {
                notification.style.transform = 'translateX(400px)';
                setTimeout(() => document.body.removeChild(notification), 300);
            }, 3000);
        }

        function handleGenericResponse(response) {
            return response.json().then(data => {
                if (data.status === 'success') {
                    showNotification(data.message || 'Operation completed successfully!', 'success');
                    setTimeout(() => window.location.reload(), 1000);
                } else {
                    showNotification(`Error: ${data.message || 'Operation failed'}`, 'error');
                }
            });
        }

        function createGalleryItem(file) {
            const item = document.createElement('div');
            item.className = 'gallery-item';
            item.dataset.fileId = file.id;
            item.dataset.fileType = file.type;
            item.setAttribute('draggable', 'true');
            item.addEventListener('dragstart', (event) => dragStart(event, file.id));

            let mediaHTML = '';
            if (file.type === 'audio') {
                mediaHTML = `<div style="display:flex; align-items:center; justify-content:center; height:100%; font-size: 4rem; color: #1ed760;">🎵</div>`;
            } else if (['image', 'animated_image'].includes(file.type)) {
                mediaHTML = `<img class="lazy" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1 1'%3E%3C/svg%3E" data-src="/galleryout/thumbnail/${file.id}" alt="${file.name}" loading="lazy">`;
            } else if (file.type === 'video') {
                mediaHTML = `<video autoplay muted loop playsinline class="lazy" data-src="/galleryout/file/${file.id}" poster="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1 1'%3E%3C/svg%3E"></video>`;
            } else {
                mediaHTML = `<div style="display: flex; align-items: center; justify-content: center; height: 100%; font-size: 3rem; color: var(--text-muted);">📄</div>`;
            }

            const summaryButtonHTML = file.has_workflow 
                ? `<button title="Node Summary" onclick="showNodeSummary(event, '${file.id}')">📝</button>`
                : '';

            const deleteButtonHTML = deletionAllowed
                ? `<button class="delete-btn" onclick="deleteFile(event, '${file.id}', this)">🗑️</button>`
                : '';

            item.innerHTML = `
                <div class="selection-checkmark" onclick="toggleSelection(event, '${file.id}', this.closest('.gallery-item'))">✓</div>
                <div class="thumbnail-link" onclick="openLightbox(event, '${file.id}'); event.stopPropagation();" draggable="false">
                    <div class="thumbnail-wrapper">
                        ${mediaHTML}
                        ${file.has_workflow ? `<a href="/galleryout/workflow/${file.id}" class="workflow-badge" onclick="event.stopPropagation()">⚙️ Workflow</a>` : ''}
                        ${file.duration ? `<span class="duration-overlay">⏱️ ${file.duration}</span>` : ''}
                    </div>
                </div>
                <div class="item-info">
                    <p title="${file.name}"><strong>${file.name}</strong>${file.dimensions ? `<br><span style="font-size:0.8rem; color: var(--text-muted)">📐 ${file.dimensions}</span>` : ''}</p>
                    <div class="item-actions">
                        ${summaryButtonHTML}
                        <button class="favorite-btn ${file.is_favorite ? 'favorited' : ''}" title="Favorite" onclick="toggleFavorite(event, '${file.id}', this)">${file.is_favorite ? '⭐' : '☆'}</button>
                        <a href="/galleryout/download/${file.id}" onclick="event.stopPropagation()" title="Download">💾</a>
                        ${deleteButtonHTML}
                    </div>
                </div>`;
            return item;
        }
        
        function appendFiles(files) {
            if (!files || files.length === 0) {
                if (currentItemCount === 0) showEmptyState();
                updateLoadMoreVisibility();
                return;
            }
            const fragment = document.createDocumentFragment();
            const newLazyElements = [];
            files.forEach(file => {
                allFilesData.push(file);
                const item = createGalleryItem(file);
                fragment.appendChild(item);
                galleryItems.push(item);
                const lazyEl = item.querySelector('.lazy');
                if (lazyEl) newLazyElements.push(lazyEl);
            });
            galleryContainer.appendChild(fragment);
            initializeLazyLoading(newLazyElements);
            currentItemCount += files.length;
            updateLoadMoreVisibility();
        }

        function updateLoadMoreVisibility() {
            const loadMoreContainer = document.getElementById('load-more-container');
            if (!loadMoreContainer) return;

            // Nascondi il bottone se il numero di elementi visualizzati è uguale o superiore al totale
            // che il backend ha comunicato per la query corrente, o se non ci sono proprio file.
            const shouldHide = currentItemCount >= totalFiles || totalFiles === 0;
            
            loadMoreContainer.style.display = shouldHide ? 'none' : 'block';
        }
        
        function showEmptyState() {
            galleryContainer.innerHTML = `<div class="empty-state" style="grid-column: 1/-1;"><h3>📭 No files found</h3><p>There are no files matching your criteria in this folder.</p></div>`;
        }

        function initializeLazyLoading(elements) {
            const observer = new IntersectionObserver((entries, obs) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        const el = entry.target;
                        if (el.dataset.src) {
                            el.src = el.dataset.src;
                            if (el.tagName === "VIDEO") el.load();
                        }
                        el.classList.remove("lazy");
                        obs.unobserve(el);
                    }
                });
            }, { rootMargin: '50px' });
            elements.forEach(el => observer.observe(el));
        }

        function createFolder() {
            const folderName = prompt("📁 Enter a name for the new folder (it will be created inside the current folder):");
            if (folderName && folderName.trim()) {
                fetch('/galleryout/create_folder', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ folder_name: folderName.trim(), parent_key: currentFolderKey })
                }).then(handleGenericResponse).catch(handleError);
            }
        }

        function renameFolder(event, folderKey, oldName) {
            event.stopPropagation();
            const newName = prompt("✏️ Enter the new name for the folder:", oldName);
            if (newName && newName.trim() && newName.trim() !== oldName) {
                fetch(`/galleryout/rename_folder/${folderKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ new_name: newName.trim() })
                }).then(handleGenericResponse).catch(handleError);
            }
        }

        function deleteFolder(event, folderKey, folderName) {
            event.stopPropagation();
            if (confirm(`🗑️ Are you sure you want to delete the folder "${folderName}" and all its contents?\n\nThis action cannot be undone.`)) {
                fetch(`/galleryout/delete_folder/${folderKey}`, { method: 'POST' }).then(handleGenericResponse).catch(handleError);
            }
        }

        function handleMainTreeToggle(event) {
            const target = event.target;
            const isMobile = window.innerWidth <= 1024;

            if (target.classList.contains('toggle-btn') && !target.classList.contains('empty')) {
                event.stopPropagation();
                target.closest('li').classList.toggle('collapsed');
                return;
            }

            if (target.classList.contains('folder-link') && target.classList.contains('navigation-link')) {
                event.stopPropagation();
                const folderLi = target.closest('li');
                const folderUrl = target.dataset.folderUrl;
                
                if (isMobile) {
                    sessionStorage.setItem('galleryMobileNav', 'true');
                    window.location.href = folderUrl;
                } else {
                    if (!folderLi.classList.contains('no-children')) {
                        folderLi.classList.toggle('collapsed');
                    }
                    if (event.detail === 2) {
                        window.location.href = folderUrl;
                    }
                }
                return;
            }
        }

        function populateAndShowDropPanel() {
            const dropZoneFolders = document.getElementById('drop-zone-folders');
            let treeHtml = `<ul class="folder-tree">${renderMoveTree('_root_', foldersData)}</ul>`;
            dropZoneFolders.innerHTML = treeHtml;
            document.getElementById('drag-drop-overlay').classList.add('visible');
            document.getElementById('drop-zone-panel').classList.add('visible');
        }

        function renderMoveTree(folderKey, allFolders) {
            const folder = allFolders[folderKey];
            if (!folder) return '';
            const hasChildren = folder.children && folder.children.length > 0;
            let html = `<li data-folder-key="${folderKey}" class="collapsed ${!hasChildren ? 'no-children' : ''}">
                <div class="drop-zone-folder-item">
                    <span class="toggle-btn ${!hasChildren ? 'empty' : ''}" onclick="event.stopPropagation(); this.closest('li').classList.toggle('collapsed');"></span>
                    <span class="folder-link" onclick="event.stopPropagation(); this.closest('li').classList.toggle('collapsed');">📁 ${folder.display_name}</span>
                    <button class="move-here-btn" style="margin-left:auto; padding: 2px 8px; font-size: 14px;" onclick="confirmMoveToFolder('${folderKey}')" ${folderKey === currentFolderKey ? 'disabled' : ''}>➜</button>
                </div>`;
            if (hasChildren) {
                html += `<ul>${folder.children.map(key => renderMoveTree(key, allFolders)).join('')}</ul>`;
            }
            html += `</li>`;
            return html;
        }

        function confirmMoveToFolder(folderKey) {
            if (!selectedFiles || selectedFiles.size === 0) { showNotification('No files selected.', 'warning'); return; }
            performBatchAction('/galleryout/move_batch', { file_ids: [...selectedFiles], destination_folder: folderKey });
            hideDropZone();
        }

        function hideDropZone() {
            document.getElementById('drag-drop-overlay').classList.remove('visible');
            document.getElementById('drop-zone-panel').classList.remove('visible');
        }

        function dragStart(event, fileId) {
            event.stopPropagation();
            if (!selectedFiles.has(fileId)) {
                deselectAll();
                selectedFiles.add(fileId);
                updateSelectionUI();
            }
            const dragImage = document.createElement('div');
            dragImage.style.cssText = `position: absolute; top: -100px; background: var(--primary-color); color: white; padding: 8px 16px; border-radius: 8px; font-weight: 600;`;
            dragImage.textContent = `📦 ${selectedFiles.size} file${selectedFiles.size !== 1 ? 's' : ''}`;
            document.body.appendChild(dragImage);
            event.dataTransfer.setDragImage(dragImage, 0, 0);
            setTimeout(() => document.body.removeChild(dragImage), 0);
            event.dataTransfer.setData('text/plain', [...selectedFiles].join(','));
            populateAndShowDropPanel();
        }

        function toggleSelection(event, fileId, item) {
            event.stopPropagation();
            const isShift = event.shiftKey;
            if (isShift && lastSelectedItem) {
                const lastIndex = galleryItems.findIndex(i => i.dataset.fileId === lastSelectedItem.dataset.fileId);
                const currentIndex = galleryItems.findIndex(i => i.dataset.fileId === fileId);
                const [start, end] = [lastIndex, currentIndex].sort((a,b) => a - b);
                for (let i = start; i <= end; i++) {
                    selectedFiles.add(galleryItems[i].dataset.fileId);
                }
            } else {
                selectedFiles.has(fileId) ? selectedFiles.delete(fileId) : selectedFiles.add(fileId);
                lastSelectedItem = item;
            }
            updateSelectionUI();
        }
        
        function updateSelectionUI() {
            galleryItems.forEach(item => {
                item.classList.toggle('selected', selectedFiles.has(item.dataset.fileId));
            });
            const count = selectedFiles.size;
            selectionCounter.textContent = `📊 ${count} file${count !== 1 ? 's' : ''} selected`;
            selectionBar.classList.toggle('visible', count > 0);
        }

        function selectAll() {
            galleryItems.forEach(item => selectedFiles.add(item.dataset.fileId));
            lastSelectedItem = galleryItems.length > 0 ? galleryItems[galleryItems.length - 1] : null;
            updateSelectionUI();
        }

        function deselectAll() {
            selectedFiles.clear();
            lastSelectedItem = null;
            updateSelectionUI();
        }

        function toggleFavorite(event, fileId, element) {
            event.stopPropagation();
            const originalContent = element.innerHTML;
            element.innerHTML = '⏳'; element.disabled = true;
            fetch(`/galleryout/toggle_favorite/${fileId}`, { method: 'POST' })
                .then(res => res.json())
                .then(data => {
                    if (data.status === 'success') {
                        element.classList.toggle('favorited', data.is_favorite);
                        element.innerHTML = data.is_favorite ? '⭐' : '☆';
                        showNotification(data.is_favorite ? 'Added to favorites!' : 'Removed from favorites!', 'success');
                    } else {
                        element.innerHTML = originalContent; showNotification('Error toggling favorite', 'error');
                    }
                })
                .catch(error => { element.innerHTML = originalContent; handleError(error); })
                .finally(() => element.disabled = false);
        }

        function deleteFile(event, fileId, element) {
            event.stopPropagation();
            if (!confirm('🗑️ Are you sure you want to delete this file? This cannot be undone.')) return;
            const item = element.closest('.gallery-item');
            element.disabled = true;
            fetch(`/galleryout/delete/${fileId}`, { method: 'POST' })
                .then(res => res.json())
                .then(data => {
                    if (data.status === 'success') {
                        item.style.transition = 'all 0.4s ease';
                        item.style.opacity = '0'; item.style.transform = 'scale(0.8)';
                        showNotification('File deleted!', 'success');
                        setTimeout(() => {
                            item.remove();
                            galleryItems = galleryItems.filter(gi => gi !== item);
                            selectedFiles.delete(fileId);
                            updateSelectionUI(); currentItemCount--; updateLoadMoreVisibility();
                        }, 400);
                    } else {
                        showNotification(`Error: ${data.message || 'Deletion failed'}`, 'error');
                        element.disabled = false;
                    }
                })
                .catch(error => { handleError(error); element.disabled = false; });
        }

        function moveSelected() { if (selectedFiles.size > 0) populateAndShowDropPanel(); }
        function deleteSelected() {
            const count = selectedFiles.size;
            if (count > 0 && confirm(`🗑️ Delete ${count} files? This cannot be undone.`)) {
                performBatchAction('/galleryout/delete_batch', { file_ids: [...selectedFiles] });
            }
        }
        function favoriteSelected(status) {
            if (selectedFiles.size === 0) return;
            performBatchAction('/galleryout/favorite_batch', { file_ids: [...selectedFiles], status: status });
        }
        function performBatchAction(url, body) {
            fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(body)
            }).then(handleGenericResponse).catch(handleError);
        }

        const lightboxOverlay = document.getElementById('lightbox-overlay');
        const lightboxMedia = document.getElementById('lightbox-media');
        const lightboxTitle = document.getElementById('lightbox-title');
        const lightboxDownload = document.getElementById('lightbox-download');
        const lightboxWorkflow = document.getElementById('lightbox-workflow');
        const lightboxNewTab = document.getElementById('lightbox-new-tab');
        let currentLightboxIndex = -1;
        let currentZoom = 1;

        function openLightbox(event, fileId) {
            if (event.target.closest('a, button')) return;
            event.stopPropagation();
            currentLightboxIndex = galleryItems.findIndex(item => item.dataset.fileId === fileId);
            if (currentLightboxIndex === -1) return;
            document.body.classList.add('lightbox-open');
            lightboxOverlay.classList.add('visible');
            showItemAtIndex(currentLightboxIndex);
        }

        function closeLightbox() {
            const mediaElement = lightboxMedia.querySelector('video, audio');
            if (mediaElement) mediaElement.pause();
            document.body.classList.remove('lightbox-open');
            lightboxOverlay.classList.remove('visible');
            lightboxMedia.innerHTML = '';
            currentLightboxIndex = -1;
        }

        function showItemAtIndex(index) {
            currentZoom = 1;
            const item = galleryItems[index];
            if (!item) return;
            const file = allFilesData.find(f => f.id === item.dataset.fileId);
            if (!file) return;

            lightboxMedia.innerHTML = '';
            lightboxTitle.textContent = file.name;
            
            if (file.type === 'audio') {
                const audio = document.createElement('audio');
                audio.src = `/galleryout/file/${file.id}`;
                audio.controls = true; audio.autoplay = true;
                lightboxMedia.appendChild(audio);
            } else if (['image', 'animated_image'].includes(file.type)) {
                const img = document.createElement('img');
                img.src = `/galleryout/file/${file.id}`;
                img.alt = file.name;
                img.style.transform = 'scale(1)';
                lightboxMedia.appendChild(img);
            } else if (file.type === 'video') {
                const video = document.createElement('video');
                video.src = `/galleryout/file/${file.id}`;
                video.controls = true; video.autoplay = true; video.loop = true;
                lightboxMedia.appendChild(video);
            } else {
                lightboxMedia.innerHTML = `<div style="color: white; font-size: 1.2rem; text-align: center;">📄<br>Preview not available</div>`;
            }

            lightboxDownload.href = `/galleryout/download/${file.id}`;
            lightboxNewTab.href = `/galleryout/file/${file.id}`;

            // --- MODIFICATO: Gestione dinamica dei pulsanti Workflow e Node Summary ---
            const summaryBtn = document.getElementById('lightbox-summary-btn');
            if (file.has_workflow) {
                lightboxWorkflow.href = `/galleryout/workflow/${file.id}`;
                lightboxWorkflow.style.display = 'flex';
                summaryBtn.style.display = 'flex';
                summaryBtn.onclick = (event) => {
                    event.stopPropagation();
                    showNodeSummary(event, file.id);
                };
            } else {
                lightboxWorkflow.style.display = 'none';
                summaryBtn.style.display = 'none';
                summaryBtn.onclick = null;
            }
        }

        function navigateLightbox(direction) {
            if (galleryItems.length === 0) return;
            currentLightboxIndex = (currentLightboxIndex + direction + galleryItems.length) % galleryItems.length;
            showItemAtIndex(currentLightboxIndex);
        }

        function zoomLightbox(amount) {
            const img = lightboxMedia.querySelector('img');
            if (!img) return;
            currentZoom = Math.max(0.5, Math.min(3, currentZoom + amount));
            img.style.transform = `scale(${currentZoom})`;
        }

        const summaryOverlay = document.getElementById('node-summary-overlay');
        const summaryContent = document.getElementById('node-summary-content');

        function escapeHTML(value) {
            if (value === null || typeof value === 'undefined') {
                return '<em>null</em>'; 
            }

            if (typeof value === 'object') {
                try {
                    const jsonString = JSON.stringify(value, null, 2); 
                    return jsonString.replace(/[&<>"']/g, m => ({'&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'})[m]);
                } catch (e) {
                    return '[Unserializable Object]';
                }
            }

            return value.toString().replace(/[&<>"']/g, m => ({'&': '&amp;', '<': '&lt;', '>': '&gt;','&quot;': '&quot;', "'": '&#39;'})[m]);
        }

        async function showNodeSummary(event, fileId) {
            event.stopPropagation();
            summaryContent.innerHTML = '<div class="loader" style="margin: 2rem auto;"></div>';
            document.body.classList.add('modal-open');
            summaryOverlay.classList.add('visible');

            try {
                const response = await fetch(`/galleryout/node_summary/${fileId}`);
                const data = await response.json();

                if (data.status === 'success' && data.summary) {
                    if (data.summary.length > 0) {
                        let contentHTML = '';
                        data.summary.forEach(node => {
                            let paramsHTML = '<ul class="summary-node-params">';
                            if (node.params && node.params.length > 0) {
                                node.params.forEach(p => {
                                    paramsHTML += `<li><strong>${escapeHTML(p.name)}:</strong> <code>${escapeHTML(p.value)}</code></li>`;
                                });
                            } else {
                                paramsHTML += `<li>No parameters</li>`;
                            }
                            paramsHTML += '</ul>';
                            contentHTML += `<div class="summary-node-item"><div class="summary-node-header" style="background-color: ${node.color};">${escapeHTML(node.type)} <small>(ID: ${node.id})</small></div>${paramsHTML}</div>`;
                        });
                        summaryContent.innerHTML = contentHTML;
                    } else {
                        summaryContent.innerHTML = '<p>No active nodes found in this workflow.</p>';
                    }
                } else {
                    summaryContent.innerHTML = `<p style="color: var(--danger-color);">Error: ${data.message || 'Could not load summary.'}</p>`;
                }
            } catch (error) {
                handleError(error);
                summaryContent.innerHTML = `<p style="color: var(--danger-color);">A network error occurred while fetching the summary.</p>`;
            }
        }
        
        function closeNodeSummary() {
            document.body.classList.remove('modal-open');
            summaryOverlay.classList.remove('visible');
            summaryContent.innerHTML = '';
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            loaderOverlay.style.opacity = '0';
            setTimeout(() => { loaderOverlay.style.display = 'none'; }, 400);

            appendFiles(initialFiles);

            new TomSelect('#extension-select', { plugins: ['checkbox_options', 'clear_button'], placeholder: '📄 Select extensions...' });
            new TomSelect('#prefix-select', { plugins: ['checkbox_options', 'clear_button'], placeholder: '🏷️ Select prefixes...' });

            const sidebar = document.querySelector('.sidebar');
            const sidebarToggleBtn = document.getElementById('sidebar-toggle-btn');
            const galleryAnchor = document.getElementById('gallery-anchor');
            const isMobile = window.innerWidth <= 1024;

            if (sidebar && sidebarToggleBtn && isMobile) {
                sidebar.classList.add('nav-collapsed');
                sidebarToggleBtn.textContent = '☰ Show Folders';
                sidebarToggleBtn.addEventListener('click', () => {
                    sidebar.classList.toggle('nav-collapsed');
                    sidebarToggleBtn.textContent = sidebar.classList.contains('nav-collapsed') ? '☰ Show Folders' : '✕ Hide Folders';
                });
            }
            
            if (isMobile && sessionStorage.getItem('galleryMobileNav') === 'true' && galleryAnchor) {
                setTimeout(() => galleryAnchor.scrollIntoView({ behavior: 'smooth', block: 'start' }), 100);
                sessionStorage.removeItem('galleryMobileNav');
            }

            document.getElementById('folder-tree-nav').addEventListener('click', handleMainTreeToggle);
            document.getElementById('refresh-btn').addEventListener('click', () => window.location.reload());
            document.getElementById('create-folder-btn').addEventListener('click', createFolder);
            document.getElementById('cancel-drop-btn').addEventListener('click', hideDropZone);
            document.getElementById('select-all-btn').addEventListener('click', selectAll);
            document.getElementById('deselect-all-btn').addEventListener('click', deselectAll);
            document.getElementById('move-selected-btn').addEventListener('click', moveSelected);
            document.getElementById('delete-selected-btn').addEventListener('click', deleteSelected);
            document.getElementById('favorite-selected-btn').addEventListener('click', () => favoriteSelected(true));
            document.getElementById('unfavorite-selected-btn').addEventListener('click', () => favoriteSelected(false));

            document.querySelector('#lightbox-overlay .close-btn').addEventListener('click', closeLightbox);
            document.getElementById('lightbox-prev').addEventListener('click', () => navigateLightbox(-1));
            document.getElementById('lightbox-next').addEventListener('click', () => navigateLightbox(1));
            document.getElementById('lightbox-zoom-in').addEventListener('click', () => zoomLightbox(0.2));
            document.getElementById('lightbox-zoom-out').addEventListener('click', () => zoomLightbox(-0.2));

            document.getElementById('close-summary-btn').addEventListener('click', closeNodeSummary);
            summaryOverlay.addEventListener('click', (event) => {
                if (event.target === summaryOverlay) closeNodeSummary();
            });

            const loadMoreBtn = document.getElementById('load-more-btn');
            if (loadMoreBtn) {
                loadMoreBtn.addEventListener('click', async function() {
                    this.disabled = true; this.innerHTML = '📂 Loading...';
                    try {
                        const response = await fetch(`/galleryout/load_more?offset=${currentItemCount}&folder_key=${currentFolderKey}`);
                        const data = await response.json();
                        if (data.files && data.files.length > 0) appendFiles(data.files);
                        else {
                            showNotification('There are no more files to load.', 'info');
                            this.style.display = 'none';
                        }
                    } catch (error) { handleError(error); }
                    if (currentItemCount < totalFiles) {
                        this.disabled = false; this.innerHTML = '📂 Load More';
                    }
                });
            }

            document.addEventListener('keydown', (event) => {
                if ((event.ctrlKey || event.metaKey) && event.key === 'a') {
                    event.preventDefault(); selectAll();
                }
                if (event.key === 'Escape') {
                    if (summaryOverlay.classList.contains('visible')) closeNodeSummary();
                    else if (lightboxOverlay.classList.contains('visible')) closeLightbox();
                    else if (selectedFiles.size > 0) deselectAll();
                    hideDropZone();
                }
                if (lightboxOverlay.classList.contains('visible')) {
                    if (event.key === 'ArrowLeft') navigateLightbox(-1);
                    if (event.key === 'ArrowRight') navigateLightbox(1);
                }
            });

            window.onscroll = () => {
                backToTopBtn.style.display = (window.scrollY > 300) ? 'block' : 'none';
            };
        });

        function scrollToTop() {
            window.scrollTo({top: 0, behavior: 'smooth'});
        }
    </script>
</body>
</html>